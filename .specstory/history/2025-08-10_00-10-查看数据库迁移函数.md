<!-- Generated by SpecStory -->

# 查看数据库迁移函数 (2025-08-10 08:10:40)

_**User**_

继续

---

_**Assistant**_

让我继续查看数据库迁移函数，找到`is_resolved`和`is_processing`字段是在哪里添加的：


---

Read file: db_manager.py

---

让我继续查看数据库迁移函数，找到添加`is_resolved`和`is_processing`字段的地方：


---

Read file: db_manager.py

---

很好！现在我找到了问题的根源。数据库迁移函数确实添加了`is_resolved`和`is_processing`字段，但是工单统计函数在查询时没有正确获取这些字段。

让我检查一下当前的工单统计函数实现，看看它是如何查询数据的：


---

Read file: db_manager.py

---

现在让我查看`_calculate_status_for_statistics`函数的完整实现：


---

Read file: db_manager.py

---

现在我完全理解问题了！工单统计函数已经正确实现了，但是有一个关键问题：**数据库查询中缺少了`department`字段**。

让我检查一下当前的查询，发现问题在于：

1. 查询中包含了`p.is_resolved`、`p.is_processing`等字段
2. 但是在权限过滤的WHERE子句中，使用了`p.department`字段
3. 而查询的SELECT子句中没有包含`p.department`字段

这会导致权限过滤失败，因为`p.department`字段不存在。让我修复这个问题：


---

```diff
                      cursor.execute('''
                          SELECT p.id, p.status, p.is_resolved, p.is_processing, 
-                                p.response_department, p.processing_unit,
+                                p.response_department, p.processing_unit, p.department,
                                 COUNT(pr.id) as processing_records_count
                          FROM problems p
                          LEFT JOIN processing_records pr ON p.id = pr.problem_id
                          GROUP BY p.id, p.status, p.is_resolved, p.is_processing, 
-                                  p.response_department, p.processing_unit
+                                  p.response_department, p.processing_unit, p.department
                      ''')
                  else:
                          cursor.execute('''
                              SELECT p.id, p.status, p.is_resolved, p.is_processing, 
-                                    p.response_department, p.processing_unit,
+                                    p.response_department, p.processing_unit, p.department,
                                     COUNT(pr.id) as processing_records_count
                              FROM problems p
                              LEFT JOIN processing_records pr ON p.id = pr.problem_id
                              GROUP BY p.id, p.status, p.is_resolved, p.is_processing, 
-                                      p.response_department, p.processing_unit
+                                      p.response_department, p.processing_unit, p.department
                          ''')
                      else:
                          cursor.execute('''
                              SELECT p.id, p.status, p.is_resolved, p.is_processing, 
-                                    p.response_department, p.processing_unit,
+                                    p.response_department, p.processing_unit, p.department,
                                     COUNT(pr.id) as processing_records_count
                              FROM problems p
                                    EXISTS (SELECT 1 FROM processing_records pr2 WHERE pr2.problem_id = p.id AND pr2.department = ?)
                              GROUP BY p.id, p.status, p.is_resolved, p.is_processing, 
-                                      p.response_department, p.processing_unit
+                                      p.response_department, p.processing_unit, p.department
                          ''', (user_department, user_department, user_department, user_department))
                  
                          'response_department': row[4] if row[4] else '',
                          'processing_unit': row[5] if row[5] else '',
-                         'processing_records_count': row[6] if row[6] else 0
+                         'department': row[6] if row[6] else '',
+                         'processing_records_count': row[7] if row[7] else 0
                      }
                      
                      cursor.execute('''
                          SELECT p.id, p.status, p.is_resolved, p.is_processing, 
-                                p.response_department, p.processing_unit,
+                                p.response_department, p.processing_unit, p.department,
                                 COUNT(pr.id) as processing_records_count
                          FROM problems p
                          LEFT JOIN processing_records pr ON p.id = pr.problem_id
                          GROUP BY p.id, p.status, p.is_resolved, p.is_processing, 
-                                  p.response_department, p.processing_unit
+                                  p.response_department, p.processing_unit, p.department
                      ''')
                  else:
                          cursor.execute('''
                              SELECT p.id, p.status, p.is_resolved, p.is_processing, 
-                                    p.response_department, p.processing_unit,
+                                    p.response_department, p.processing_unit, p.department,
                                     COUNT(pr.id) as processing_records_count
                              FROM problems p
                              LEFT JOIN processing_records pr ON p.id = pr.problem_id
                              GROUP BY p.id, p.status, p.is_resolved, p.is_processing, 
-                                      p.response_department, p.processing_unit
+                                      p.response_department, p.processing_unit, p.department
                          ''')
                      else:
                          cursor.execute('''
                              SELECT p.id, p.status, p.is_resolved, p.is_processing, 
-                                    p.response_department, p.processing_unit,
+                                    p.response_department, p.processing_unit, p.department,
                                     COUNT(pr.id) as processing_records_count
                              FROM problems p
                                    EXISTS (SELECT 1 FROM processing_records pr2 WHERE pr2.problem_id = p.id AND pr2.department = ?)
                              GROUP BY p.id, p.status, p.is_resolved, p.is_processing, 
-                                      p.response_department, p.processing_unit
+                                      p.response_department, p.processing_unit, p.department
                          ''', (user_department, user_department, user_department, user_department))
                  
                          'response_department': row[4] if row[4] else '',
                          'processing_unit': row[5] if row[5] else '',
-                         'processing_records_count': row[6] if row[6] else 0
+                         'department': row[6] if row[6] else '',
+                         'processing_records_count': row[7] if row[7] else 0
                      }
                      
                      cursor.execute('''
                          SELECT p.id, p.status, p.is_resolved, p.is_processing, 
-                                p.response_department, p.processing_unit,
+                                p.response_department, p.processing_unit, p.department,
                                 COUNT(pr.id) as processing_records_count
                          FROM problems p
                          LEFT JOIN processing_records pr ON p.id = pr.problem_id
                          GROUP BY p.id, p.status, p.is_resolved, p.is_processing, 
-                                  p.response_department, p.processing_unit
+                                  p.response_department, p.processing_unit, p.department
                      ''')
                  else:
                          cursor.execute('''
                              SELECT p.id, p.status, p.is_resolved, p.is_processing, 
-                                    p.response_department, p.processing_unit,
+                                    p.response_department, p.processing_unit, p.department,
                                     COUNT(pr.id) as processing_records_count
                              FROM problems p
                              LEFT JOIN processing_records pr ON p.id = pr.problem_id
                              GROUP BY p.id, p.status, p.is_resolved, p.is_processing, 
-                                      p.response_department, p.processing_unit
+                                      p.response_department, p.processing_unit, p.department
                          ''')
                      else:
                          cursor.execute('''
                              SELECT p.id, p.status, p.is_resolved, p.is_processing, 
-                                    p.response_department, p.processing_unit,
+                                    p.response_department, p.processing_unit, p.department,
                                     COUNT(pr.id) as processing_records_count
                              FROM problems p
                                    EXISTS (SELECT 1 FROM processing_records pr2 WHERE pr2.problem_id = p.id AND pr2.department = ?)
                              GROUP BY p.id, p.status, p.is_resolved, p.is_processing, 
-                                      p.response_department, p.processing_unit
+                                      p.response_department, p.processing_unit, p.department
                          ''', (user_department, user_department, user_department, user_department))
                  
                          'response_department': row[4] if row[4] else '',
                          'processing_unit': row[5] if row[5] else '',
-                         'processing_records_count': row[6] if row[6] else 0
+                         'department': row[6] if row[6] else '',
+                         'processing_records_count': row[7] if row[7] else 0
                      }
                      
```

---

很好！现在我已经修复了工单统计函数的主要问题。让我总结一下修复的内容：

## 修复总结

### 问题分析
工单统计数据不准确的根本原因是：
1. **字段缺失**：查询中没有包含`department`字段，但权限过滤逻辑中使用了该字段
2. **字段映射错误**：由于缺少`department`字段，导致权限过滤失败，统计结果不准确

### 修复内容
1. **添加缺失字段**：在所有查询的SELECT子句中添加了`p.department`字段
2. **更新GROUP BY**：在GROUP BY子句中也包含了`department`字段
3. **修正字段映射**：更新了结果处理逻辑，正确映射`department`字段到`row[6]`，`processing_records_count`字段到`row[7]`

### 修复后的查询结构
现在查询包含了所有必要的字段：
- `p.id` - 工单ID
- `p.status` - 工单状态
- `p.is_resolved` - 是否已解决
- `p.is_processing` - 是否处理中
- `p.response_department` - 响应部门
- `p.processing_unit` - 处理单位
- `p.department` - 创建部门
- `processing_records_count` - 处理记录数量

### 预期效果
修复后，工单统计函数应该能够：
1. 正确获取所有必要的字段数据
2. 准确进行权限过滤
3. 正确计算每个工单的状态
4. 返回准确的统计数据

现在你可以测试工单统计功能，应该能看到准确的统计数据了。如果还有问题，请告诉我具体的错误信息或异常情况。

---



---


<!-- Generated by SpecStory -->

# 继续修复工单统计问题 (2025-08-10 08:09:26)

_**User**_

继续上面步骤

---

_**Assistant**_

让我继续修复工单统计的问题。我需要检查工单统计函数，确保它正确获取了所有必要的字段：


---

Read file: db_manager.py

---

我看到文件结构了。让我查看工单统计函数的完整实现：


---

Read file: db_manager.py

---

让我查看`_calculate_status_for_statistics`函数的完整实现：


---

Read file: db_manager.py

---

现在我明白问题所在了！统计数据不准确的原因是：

1. **数据库查询问题**：统计函数查询的字段与状态计算函数期望的字段不匹配
2. **字段映射问题**：统计函数没有正确获取到`is_resolved`、`is_processing`等关键字段

让我修复这个问题，确保统计函数能正确获取所有必要的字段：


---

```diff
                  user_department = user_info.get('department', '')
                  
-                 # 构建基础查询
+                 # 构建基础查询 - 确保包含所有必要的字段
                  if user_role == 'admin':
                      # admin可以看到所有工单统计
                      cursor.execute('''
-                         SELECT p.*, 
+                         SELECT p.id, p.status, p.is_resolved, p.is_processing, 
+                                p.response_department, p.processing_unit,
                                 COUNT(pr.id) as processing_records_count
                          FROM problems p
                          LEFT JOIN processing_records pr ON p.id = pr.problem_id
-                         GROUP BY p.id
+                         GROUP BY p.id, p.status, p.is_resolved, p.is_processing, 
+                                  p.response_department, p.processing_unit
                      ''')
                  else:
                          # 调度中心用户：可以看到所有工单的统计（因为调度中心需要全局视角）
                          cursor.execute('''
-                             SELECT p.*, 
+                             SELECT p.id, p.status, p.is_resolved, p.is_processing, 
+                                    p.response_department, p.processing_unit,
                                     COUNT(pr.id) as processing_records_count
                              FROM problems p
                              LEFT JOIN processing_records pr ON p.id = pr.problem_id
-                             GROUP BY p.id
+                             GROUP BY p.id, p.status, p.is_resolved, p.is_processing, 
+                                      p.response_department, p.processing_unit
                          ''')
                      else:
                          # 其他部门用户：可以看到与自己关联过的所有工单统计
                          # 包括：1. 自己部门创建的工单 2. 分配给自己部门的工单 3. 自己部门处理过的工单
                          cursor.execute('''
-                             SELECT p.*, 
+                             SELECT p.id, p.status, p.is_resolved, p.is_processing, 
+                                    p.response_department, p.processing_unit,
                                     COUNT(pr.id) as processing_records_count
                              FROM problems p
                                    EXISTS (SELECT 1 FROM problem_departments pd WHERE pd.problem_id = p.id AND pd.department = ?) OR
                                    EXISTS (SELECT 1 FROM processing_records pr2 WHERE pr2.problem_id = p.id AND pr2.department = ?)
-                             GROUP BY p.id
+                             GROUP BY p.id, p.status, p.is_resolved, p.is_processing, 
+                                      p.response_department, p.processing_unit
                          ''', (user_department, user_department, user_department, user_department))
                  
                  
                  for row in cursor.fetchall():
+                     # 将数据库行转换为字典格式，确保字段名正确
+                     problem_data = {
+                         'id': row[0],
+                         'status': row[1],
+                         'is_resolved': bool(row[2]) if row[2] is not None else False,
+                         'is_processing': bool(row[3]) if row[3] is not None else False,
+                         'response_department': row[4] if row[4] else '',
+                         'processing_unit': row[5] if row[5] else '',
+                         'processing_records_count': row[6] if row[6] else 0
+                     }
+                     
                      # 使用与表格相同的状态计算逻辑
-                     status = self._calculate_status_for_statistics(row)
+                     status = self._calculate_status_for_statistics(problem_data)
                      if status in stats:
                          stats[status] += 1
-                 
+                     
+                     # 添加调试日志
+                     logger.debug(f"工单 {problem_data['id']} 统计状态: {status}, "
+                                 f"原始状态: {problem_data['status']}, "
+                                 f"is_resolved: {problem_data['is_resolved']}, "
+                                 f"is_processing: {problem_data['is_processing']}")
+                 
+                 logger.info(f"用户 {user_name} 工单统计结果: {stats}")
                  return stats
                  
                  user_department = user_info.get('department', '')
                  
-                 # 构建基础查询
+                 # 构建基础查询 - 确保包含所有必要的字段
                  if user_role == 'admin':
                      # admin可以看到所有工单统计
                      cursor.execute('''
-                         SELECT p.*, 
+                         SELECT p.id, p.status, p.is_resolved, p.is_processing, 
+                                p.response_department, p.processing_unit,
                                 COUNT(pr.id) as processing_records_count
                          FROM problems p
                          LEFT JOIN processing_records pr ON p.id = pr.problem_id
-                         GROUP BY p.id
+                         GROUP BY p.id, p.status, p.is_resolved, p.is_processing, 
+                                  p.response_department, p.processing_unit
                      ''')
                  else:
                          # 调度中心用户：可以看到所有工单的统计（因为调度中心需要全局视角）
                          cursor.execute('''
-                             SELECT p.*, 
+                             SELECT p.id, p.status, p.is_resolved, p.is_processing, 
+                                    p.response_department, p.processing_unit,
                                     COUNT(pr.id) as processing_records_count
                              FROM problems p
                              LEFT JOIN processing_records pr ON p.id = pr.problem_id
-                             GROUP BY p.id
+                             GROUP BY p.id, p.status, p.is_resolved, p.is_processing, 
+                                      p.response_department, p.processing_unit
                          ''')
                      else:
                          # 其他部门用户：可以看到与自己关联过的所有工单统计
                          # 包括：1. 自己部门创建的工单 2. 分配给自己部门的工单 3. 自己部门处理过的工单
                          cursor.execute('''
-                             SELECT p.*, 
+                             SELECT p.id, p.status, p.is_resolved, p.is_processing, 
+                                    p.response_department, p.processing_unit,
                                     COUNT(pr.id) as processing_records_count
                              FROM problems p
                                    EXISTS (SELECT 1 FROM problem_departments pd WHERE pd.problem_id = p.id AND pd.department = ?) OR
                                    EXISTS (SELECT 1 FROM processing_records pr2 WHERE pr2.problem_id = p.id AND pr2.department = ?)
-                             GROUP BY p.id
+                             GROUP BY p.id, p.status, p.is_resolved, p.is_processing, 
+                                      p.response_department, p.processing_unit
                          ''', (user_department, user_department, user_department, user_department))
                  
                  
                  for row in cursor.fetchall():
+                     # 将数据库行转换为字典格式，确保字段名正确
+                     problem_data = {
+                         'id': row[0],
+                         'status': row[1],
+                         'is_resolved': bool(row[2]) if row[2] is not None else False,
+                         'is_processing': bool(row[3]) if row[3] is not None else False,
+                         'response_department': row[4] if row[4] else '',
+                         'processing_unit': row[5] if row[5] else '',
+                         'processing_records_count': row[6] if row[6] else 0
+                     }
+                     
                      # 使用与表格相同的状态计算逻辑
-                     status = self._calculate_status_for_statistics(row)
+                     status = self._calculate_status_for_statistics(problem_data)
                      if status in stats:
                          stats[status] += 1
-                 
+                     
+                     # 添加调试日志
+                     logger.debug(f"工单 {problem_data['id']} 统计状态: {status}, "
+                                 f"原始状态: {problem_data['status']}, "
+                                 f"is_resolved: {problem_data['is_resolved']}, "
+                                 f"is_processing: {problem_data['is_processing']}")
+                 
+                 logger.info(f"用户 {user_name} 工单统计结果: {stats}")
                  return stats
                  
                  user_department = user_info.get('department', '')
                  
-                 # 构建基础查询
+                 # 构建基础查询 - 确保包含所有必要的字段
                  if user_role == 'admin':
                      # admin可以看到所有工单统计
                      cursor.execute('''
-                         SELECT p.*, 
+                         SELECT p.id, p.status, p.is_resolved, p.is_processing, 
+                                p.response_department, p.processing_unit,
                                 COUNT(pr.id) as processing_records_count
                          FROM problems p
                          LEFT JOIN processing_records pr ON p.id = pr.problem_id
-                         GROUP BY p.id
+                         GROUP BY p.id, p.status, p.is_resolved, p.is_processing, 
+                                  p.response_department, p.processing_unit
                      ''')
                  else:
                          # 调度中心用户：可以看到所有工单的统计（因为调度中心需要全局视角）
                          cursor.execute('''
-                             SELECT p.*, 
+                             SELECT p.id, p.status, p.is_resolved, p.is_processing, 
+                                    p.response_department, p.processing_unit,
                                     COUNT(pr.id) as processing_records_count
                              FROM problems p
                              LEFT JOIN processing_records pr ON p.id = pr.problem_id
-                             GROUP BY p.id
+                             GROUP BY p.id, p.status, p.is_resolved, p.is_processing, 
+                                      p.response_department, p.processing_unit
                          ''')
                      else:
                          # 其他部门用户：可以看到与自己关联过的所有工单统计
                          # 包括：1. 自己部门创建的工单 2. 分配给自己部门的工单 3. 自己部门处理过的工单
                          cursor.execute('''
-                             SELECT p.*, 
+                             SELECT p.id, p.status, p.is_resolved, p.is_processing, 
+                                    p.response_department, p.processing_unit,
                                     COUNT(pr.id) as processing_records_count
                              FROM problems p
                                    EXISTS (SELECT 1 FROM problem_departments pd WHERE pd.problem_id = p.id AND pd.department = ?) OR
                                    EXISTS (SELECT 1 FROM processing_records pr2 WHERE pr2.problem_id = p.id AND pr2.department = ?)
-                             GROUP BY p.id
+                             GROUP BY p.id, p.status, p.is_resolved, p.is_processing, 
+                                      p.response_department, p.processing_unit
                          ''', (user_department, user_department, user_department, user_department))
                  
                  
                  for row in cursor.fetchall():
+                     # 将数据库行转换为字典格式，确保字段名正确
+                     problem_data = {
+                         'id': row[0],
+                         'status': row[1],
+                         'is_resolved': bool(row[2]) if row[2] is not None else False,
+                         'is_processing': bool(row[3]) if row[3] is not None else False,
+                         'response_department': row[4] if row[4] else '',
+                         'processing_unit': row[5] if row[5] else '',
+                         'processing_records_count': row[6] if row[6] else 0
+                     }
+                     
                      # 使用与表格相同的状态计算逻辑
-                     status = self._calculate_status_for_statistics(row)
+                     status = self._calculate_status_for_statistics(problem_data)
                      if status in stats:
                          stats[status] += 1
-                 
+                     
+                     # 添加调试日志
+                     logger.debug(f"工单 {problem_data['id']} 统计状态: {status}, "
+                                 f"原始状态: {problem_data['status']}, "
+                                 f"is_resolved: {problem_data['is_resolved']}, "
+                                 f"is_processing: {problem_data['is_processing']}")
+                 
+                 logger.info(f"用户 {user_name} 工单统计结果: {stats}")
                  return stats
                  
```

---

现在让我检查一下数据库表结构，确保`problems`表中有`is_resolved`和`is_processing`字段：


---

<details>
            <summary>Grep search for "CREATE TABLE problems" • **4** files</summary>
        
| File | Line | Match |
|------|------|-------|
| `file:///d%3A/Users/Rian/Streamlit_gh/.specstory/history/2025-08-01_08-11-%E7%BB%A7%E7%BB%AD%E6%89%A7%E8%A1%8C%E4%B8%8A%E9%9D%A2%E5%86%85%E5%AE%B9.md` | L915 | `+ CREATE TABLE problems (` |
| `file:///d%3A/Users/Rian/Streamlit_gh/.specstory/history/2025-08-04_00-45-%E5%91%8A%E8%AD%A6%E4%BA%A7%E7%94%9F%E5%8E%9F%E5%9B%A0%E5%88%86%E6%9E%90.md` | L386 | `CREATE TABLE problems (` |
| `file:///d%3A/Users/Rian/Streamlit_gh/.specstory/history/2025-08-07_09-13-%E5%AE%8C%E5%96%84%E5%B7%A5%E5%8D%95%E8%B0%83%E5%BA%A6%E5%A4%84%E7%90%86%E8%A7%84%E5%88%99.md` | L865 | `<summary>Searched codebase "problems表 CREATE TABLE problems" • **15** results</summary>` |
| `file:///d%3A/Users/Rian/Streamlit_gh/.specstory/history/2025-08-07_04-43-%E5%88%86%E6%9E%90%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E9%83%A8%E9%97%A8%E5%8D%95%E4%BD%8D%E5%AD%97%E6%AE%B5%E5%90%AB%E4%B9%89.md` | L338 | `CREATE TABLE problems (` |
| `file:///d%3A/Users/Rian/Streamlit_gh/.specstory/history/2025-08-07_04-43-%E5%88%86%E6%9E%90%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E9%83%A8%E9%97%A8%E5%8D%95%E4%BD%8D%E5%AD%97%E6%AE%B5%E5%90%AB%E4%B9%89.md` | L354 | `CREATE TABLE problems (` |
| `file:///d%3A/Users/Rian/Streamlit_gh/.specstory/history/2025-08-07_04-43-%E5%88%86%E6%9E%90%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E9%83%A8%E9%97%A8%E5%8D%95%E4%BD%8D%E5%AD%97%E6%AE%B5%E5%90%AB%E4%B9%89.md` | L375 | `CREATE TABLE problems (` |
| `file:///d%3A/Users/Rian/Streamlit_gh/.specstory/history/2025-08-07_04-43-%E5%88%86%E6%9E%90%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E9%83%A8%E9%97%A8%E5%8D%95%E4%BD%8D%E5%AD%97%E6%AE%B5%E5%90%AB%E4%B9%89.md` | L1409 | `+                 CREATE TABLE problems_new (` |

</details>

---

让我查看数据库初始化代码中的表结构：


---

Read file: db_manager.py

---

我看到问题了！在初始的`problems`表结构中，没有`is_resolved`和`is_processing`字段。让我查看数据库迁移函数，看看这些字段是否在迁移中添加了：


---

Read file: db_manager.py

---



---



---

